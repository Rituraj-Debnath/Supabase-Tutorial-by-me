receivers:
  filelog:
    include:
      - /var/lib/docker/containers/*/*.log
    # This operator turns the raw Docker JSON string into structured data
    exclude:
      # Stop OTEL from reading its own logs and GreptimeDB's logs
      - /var/lib/docker/containers/*/*supabase-otel*.log
      - /var/lib/docker/containers/*/*supabase-greptimedb*.log
    operators:
      - type: json_parser
        timestamp:
          parse_from: attributes.time
          layout: '%Y-%m-%dT%H:%M:%S.%LZ'
    # This adds the container ID to the log so we can identify it
    include_file_path: true
    include_file_name: false
  
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4319
      http:
        endpoint: 0.0.0.0:4318

processors:
  memory_limiter:
    check_interval: 1s
    # limit_mib should be ~80-90% of your Docker limit (1500MB * 0.8 = 1200MB)
    limit_mib: 820
    # spike_limit_mib should be ~20% of the limit
    spike_limit_mib: 200
  batch:
    send_batch_size: 1000
    timeout: 10s
  # This makes the logs readable by adding container names/labels
  resourcedetection:
    detectors: [env, docker]

exporters:
  # This sends the logs to your new GreptimeDB container
  otlphttp/greptimedb:
    endpoint: "http://supabase-greptimedb:4000/v1/otlp"  #using the internal port 4000 for greptimedb
    headers:
      "X-Greptime-DB-Name": "public"
    tls:
      insecure: true

  # For now, we will print logs to the terminal to confirm it works
  debug:
    verbosity: basic

service:
  pipelines:
    logs:
      receivers: [filelog, otlp]
      processors: [memory_limiter, resourcedetection, batch]
      exporters: [debug, otlphttp/greptimedb]